# SUMMARY: Рефакторинг проекта для работы только с алиасами

## Обзор изменений

Проект был полностью рефакторирован для работы только с алиасами пользователей и групп LDAP. Удален весь функционал создания пользователей, настройки аутентификации Dovecot/SOGo, оставлена только синхронизация алиасов.

## Детальный список выполненных изменений

### 1. Удаление конфигурационных шаблонов
**Файлы удалены:**
- `templates/dovecot/extra.conf`
- `templates/dovecot/ldap/passdb.conf` 
- `templates/sogo/plist_ldap`
- Вся папка `templates/`

**Обоснование:** Убрана настройка LDAP-аутентификации для Dovecot и SOGo, так как теперь используется только синхронизация алиасов.

### 2. Упрощение API модуля (api.py)

**Удаленные функции:**
- `add_user()` - создание пользователей
- Импорты `random`, `string` - больше не нужны для генерации паролей

**Модифицированные функции:**
- `edit_user()` - убран параметр `name`, оставлен только `active` для отключения пользователей
- `check_user()` - убран возврат `api_name`, теперь возвращает только `(api_user_exists, api_user_active)`
- `__delete_user()` - удалена полностью

**Оставленные функции:**
- `edit_user()` - для отключения удаленных пользователей (опционально)
- `check_user()` - для проверки существования пользователей
- Все функции работы с алиасами: `add_alias()`, `edit_alias()`, `delete_alias()`, `check_alias()`

### 3. Упрощение модуля базы данных (filedb.py)

**Удаленные функции:**
- `add_user()` - создание пользователей в локальной БД

**Оставленные функции:**
- Таблица `users` и класс `DbUser` - для отслеживания удаленных пользователей
- `get_unchecked_active_users()`, `check_user()`, `user_set_active_to()` - для функции отключения удаленных пользователей
- Все функции работы с алиасами

### 4. Рефакторинг основной логики синхронизации (syncer.py)

**Удаленные функции:**
- `apply_config()` - применение конфигурационных файлов
- `read_dovecot_passdb_conf_template()` - чтение шаблона Dovecot
- `read_sogo_plist_ldap_template()` - чтение шаблона SOGo  
- `read_dovecot_extra_conf()` - чтение дополнительной конфигурации Dovecot

**Удаленные импорты:**
- `from pathlib import Path` - больше не нужен для создания директорий конфигурации
- `from string import Template` - больше не нужен для шаблонов

**Модифицированная функция `main()`:**
- Убрана генерация и применение конфигурационных файлов
- Убрана установка `api.api_quota` - больше не используется

**Модифицированная функция `sync()`:**
- Секция "Iterate LDAP Users" переименована в "Iterate LDAP Users (User Aliases Only)"
- Убрано создание и синхронизация пользователей
- Убрано обновление имен пользователей
- Оставлена только обработка алиасов из `proxyAddresses`
- Добавлено условие для секции "Check for deleted users in LDAP" с проверкой переменной `DISABLE_DELETED_USERS`

**Модифицированная функция `read_config()`:**
- Убраны обязательные переменные: `LDAP_MAILCOW_LDAP_GC_URI`, `LDAP_MAILCOW_LDAP_DOMAIN`, `LDAP_MAILCOW_API_QUOTA`
- Убрана переменная `SOGO_LDAP_FILTER` - больше не нужна
- Добавлена переменная `DISABLE_DELETED_USERS` для управления отключением удаленных пользователей

### 5. Обновление Dockerfile

**Изменения:**
- Убрано копирование папки `templates`
- Убраны volume для `/conf/dovecot` и `/conf/sogo`
- Оставлен только volume `/db` для SQLite базы данных

### 6. Новые переменные окружения

**Добавлена переменная:**
- `LDAP_MAILCOW_DISABLE_DELETED_USERS` (опциональная, по умолчанию `false`)
  - `true` - скрипт будет отключать пользователей, удаленных из LDAP
  - `false` или не задана - функция отключения не используется (подходит для встроенной синхронизации mailcow)

**Убраны переменные:**
- `LDAP_MAILCOW_LDAP_GC_URI` - Global Catalog URI больше не нужен
- `LDAP_MAILCOW_LDAP_DOMAIN` - домен больше не используется
- `LDAP_MAILCOW_API_QUOTA` - квота больше не устанавливается
- `LDAP_MAILCOW_SOGO_LDAP_FILTER` - фильтр SOGo больше не нужен

### 7. Обновление документации (README.md)

**Полностью переписан README:**
- Убрано описание создания пользователей и настройки аутентификации
- Добавлено подробное описание работы только с алиасами
- Описаны алиасы пользователей (из `proxyAddresses`) 
- Описаны алиасы групп
- Добавлено описание опциональной функции отключения удаленных пользователей
- Обновлен пример `docker-compose.override.yml` с новыми переменными
- Убраны секции про WebUI/EAS аутентификацию и тонкую настройку LDAP

## Оставшийся функционал

После рефакторинга проект выполняет только следующие функции:

### 1. Синхронизация пользовательских алиасов
- Извлечение алиасов из атрибута `proxyAddresses` пользователей LDAP
- Создание/обновление алиасов в mailcow через API
- Активация/деактивация алиасов в зависимости от статуса пользователя в LDAP

### 2. Синхронизация групповых алиасов  
- Поиск групп LDAP с атрибутом `mail`
- Создание алиасов, которые направляют письма на всех участников группы
- Автоматическое обновление состава алиасов при изменении участников группы

### 3. Опциональное отключение удаленных пользователей
- При установке `LDAP_MAILCOW_DISABLE_DELETED_USERS=true` отключает пользователей в mailcow, которые больше не найдены в LDAP
- По умолчанию отключено для совместимости со встроенной синхронизацией пользователей mailcow

### 4. Управление жизненным циклом алиасов
- Автоматическое удаление алиасов, которые больше не существуют в LDAP
- Ведение локальной SQLite базы данных для отслеживания изменений
- Логирование всех операций для мониторинга

## Преимущества после рефакторинга

1. **Упрощение архитектуры** - убрана сложная логика настройки аутентификации
2. **Совместимость** - теперь можно использовать с встроенной синхронизацией пользователей mailcow
3. **Фокус на алиасах** - специализированный инструмент для управления только алиасами
4. **Гибкость** - опциональное управление пользователями через переменную окружения
5. **Меньше зависимостей** - убраны файлы конфигурации и связанная логика

## Совместимость

Изменения обратно совместимы в том смысле, что:
- Все существующие алиасы продолжат работать
- Можно безопасно обновиться с предыдущей версии
- Пользователи, созданные ранее, не будут затронуты (если не включена функция отключения)

Рекомендуется использовать встроенную синхронизацию пользователей mailcow для создания почтовых ящиков, а этот инструмент - только для алиасов.
